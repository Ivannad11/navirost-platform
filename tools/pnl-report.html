<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&L –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–Ω–ª–∞–π–Ω ‚Äî –ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏–±—ã–ª–µ–π –∏ —É–±—ã—Ç–∫–æ–≤ | –ù–∞–≤—ã—Ä–æ—Å—Ç</title>
    <meta name="description" content="–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π P&L –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (–æ—Ç—á–µ—Ç –æ –ø—Ä–∏–±—ã–ª—è—Ö –∏ —É–±—ã—Ç–∫–∞—Ö). –°–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–π—Ç–µ –¥–æ—Ö–æ–¥—ã, —Ä–∞—Å—Ö–æ–¥—ã –∏ –∫–∞—Å—Å–æ–≤—ã–µ —Ä–∞–∑—Ä—ã–≤—ã –Ω–∞ 6 –º–µ—Å—è—Ü–µ–≤ –≤–ø–µ—Ä–µ–¥.">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../css/calculators.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üí∞</text></svg>">
    <style>
        .calculator-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
        }
        
        /* Dashboard overrides */
        .calc-header {
            text-align: left;
            margin-bottom: 32px;
        }
        
        .calc-header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .calc-header p {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 100%;
            margin: 0;
        }

        .pnl-container {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
            margin-bottom: 32px;
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 13px;
            color: var(--text-primary);
        }

        th:first-child, td:first-child {
            text-align: left;
            width: 200px;
            position: sticky;
            left: 0;
            background: var(--bg-surface);
            z-index: 10;
            border-right: 1px solid var(--border-subtle);
        }

        th {
            font-weight: 600;
            color: var(--text-tertiary);
            font-size: 11px;
            text-transform: uppercase;
            padding-bottom: 16px;
        }

        .row-header {
            font-weight: 500;
        }

        .row-total {
            font-weight: 700;
            background: var(--bg-subtle);
        }
        .row-total td:first-child { background: var(--bg-subtle); }

        .input-cell {
            width: 90px;
            padding: 6px 8px;
            border: 1px solid transparent;
            border-radius: 6px;
            text-align: right;
            font-family: inherit;
            font-size: 13px;
            background: transparent;
            transition: all 0.2s;
        }
        .input-cell:hover, .input-cell:focus {
            background: var(--bg-subtle);
            border-color: var(--border-subtle);
            outline: none;
        }

        .cta-block {
            background: linear-gradient(135deg, #F4F4F5 0%, #FFFFFF 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            color: var(--text-primary);
        }
        
        .cta-block h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .cta-block p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .calculator-container { padding-top: 0; }
        }
    </style>
</head>
<body>
    
    <!-- Mobile Header -->
    <div class="mobile-header">
        <a href="#" class="sidebar-logo">–Ω–∞–≤—ã—Ä–æ—Å—Ç.</a>
        <button class="burger-btn" onclick="toggleSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="dashboard-container no-sidebar-right">
        
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="../index.html" class="sidebar-logo">–Ω–∞–≤—ã—Ä–æ—Å—Ç.</a>
            <ul class="nav-menu">
                <!-- Populated by sidebar-logic.js -->
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="calculator-container">
                <div class="calc-header">
                    <h1>P&L –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
                    <p>–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏–±—ã–ª–µ–π –∏ —É–±—ã—Ç–∫–æ–≤ –Ω–∞ 6 –º–µ—Å—è—Ü–µ–≤.</p>
                </div>

                <div class="pnl-container">
                    <div class="form-group" style="margin-bottom: 20px; max-width: 300px;">
                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display:block;">–ù–∞–ª–æ–≥–æ–≤—ã–π —Ä–µ–∂–∏–º:</label>
                        <select id="tax-regime" class="form-input" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-subtle); background: var(--bg-surface);">
                            <option value="usn-6">–£–°–ù 6% (–î–æ—Ö–æ–¥—ã)</option>
                            <option value="usn-15">–£–°–ù 15% (–î–æ—Ö–æ–¥—ã –º–∏–Ω—É—Å —Ä–∞—Å—Ö–æ–¥—ã)</option>
                        </select>
                    </div>
                    <table id="pnlTable">
                        <thead>
                            <tr>
                                <th>–°—Ç–∞—Ç—å—è</th>
                                <th>–ú–µ—Å—è—Ü 1</th>
                                <th>–ú–µ—Å—è—Ü 2</th>
                                <th>–ú–µ—Å—è—Ü 3</th>
                                <th>–ú–µ—Å—è—Ü 4</th>
                                <th>–ú–µ—Å—è—Ü 5</th>
                                <th>–ú–µ—Å—è—Ü 6</th>
                                <th>–ò—Ç–æ–≥–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Revenue -->
                            <tr>
                                <td class="row-header">–í—ã—Ä—É—á–∫–∞</td>
                                <td><input type="number" class="input-cell revenue" value="0"></td>
                                <td><input type="number" class="input-cell revenue" value="0"></td>
                                <td><input type="number" class="input-cell revenue" value="0"></td>
                                <td><input type="number" class="input-cell revenue" value="0"></td>
                                <td><input type="number" class="input-cell revenue" value="0"></td>
                                <td><input type="number" class="input-cell revenue" value="0"></td>
                                <td class="row-sum">0</td>
                            </tr>
                            
                            <!-- COGS -->
                            <tr>
                                <td class="row-header">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</td>
                                <td><input type="number" class="input-cell cogs" value="0"></td>
                                <td><input type="number" class="input-cell cogs" value="0"></td>
                                <td><input type="number" class="input-cell cogs" value="0"></td>
                                <td><input type="number" class="input-cell cogs" value="0"></td>
                                <td><input type="number" class="input-cell cogs" value="0"></td>
                                <td><input type="number" class="input-cell cogs" value="0"></td>
                                <td class="row-sum">0</td>
                            </tr>

                            <!-- Gross Profit -->
                            <tr class="row-total">
                                <td>–í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å</td>
                                <td class="gp">0</td>
                                <td class="gp">0</td>
                                <td class="gp">0</td>
                                <td class="gp">0</td>
                                <td class="gp">0</td>
                                <td class="gp">0</td>
                                <td class="gp-total">0</td>
                            </tr>

                            <!-- OPEX Header -->
                            <tr>
                                <td colspan="8" style="text-align: left; font-size: 11px; font-weight: 600; color: var(--text-tertiary); padding-top: 24px; text-transform: uppercase;">–†–∞—Å—Ö–æ–¥—ã (OPEX)</td>
                            </tr>

                            <!-- Marketing -->
                            <tr>
                                <td class="row-header">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td class="row-sum">0</td>
                            </tr>

                            <!-- Salaries -->
                            <tr>
                                <td class="row-header">–ó–∞—Ä–ø–ª–∞—Ç—ã</td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td class="row-sum">0</td>
                            </tr>

                            <!-- Rent/Other -->
                            <tr>
                                <td class="row-header">–ê—Ä–µ–Ω–¥–∞ –∏ –ø—Ä–æ—á–µ–µ</td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td><input type="number" class="input-cell opex" value="0"></td>
                                <td class="row-sum">0</td>
                            </tr>

                            <!-- Taxes -->
                            <tr class="row-subtotal">
                                <td>–ù–∞–ª–æ–≥–∏</td>
                                <td class="tax">0</td>
                                <td class="tax">0</td>
                                <td class="tax">0</td>
                                <td class="tax">0</td>
                                <td class="tax">0</td>
                                <td class="tax">0</td>
                                <td class="row-sum">0</td>
                            </tr>

                            <!-- Net Profit -->
                            <tr class="row-total" style="border-top: 2px solid var(--border-strong);">
                                <td>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</td>
                                <td class="net">0</td>
                                <td class="net">0</td>
                                <td class="net">0</td>
                                <td class="net">0</td>
                                <td class="net">0</td>
                                <td class="net">0</td>
                                <td class="net-total">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="cta-block" id="auth-cta" style="display: none;">
                    <h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç?</h3>
                    <p>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ–µ–∫—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.</p>
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                        <button class="btn-secondary" onclick="exportPDF()" id="pdfBtn" style="border: 1px solid var(--border-strong); padding: 8px 16px; border-radius: 8px; background: white; cursor: pointer; font-size: 13px;">
                            –°–∫–∞—á–∞—Ç—å PDF
                        </button>
                        <button class="btn-primary" onclick="saveToProject()">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç
                        </button>
                    </div>
                </div>

                <!-- CTA for Guests (Marketing) -->
                <div class="cta-block guest-marketing" id="guest-cta" style="display: none; background: linear-gradient(135deg, #18181B 0%, #27272A 100%); color: white; border: none;">
                    <h3 style="color: white; font-size: 20px;">–ü–æ–Ω—Ä–∞–≤–∏–ª—Å—è —Ä–∞—Å—á–µ—Ç?</h3>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 24px; max-width: 600px; margin-left: auto; margin-right: auto;">
                        –í—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—á–µ—Ç –≤ PDF –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–∞—Å—á–µ—Ç—ã –≤ –ø—Ä–æ–µ–∫—Ç—ã –∏ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º.
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="exportPDF()" class="btn-primary" style="background: white; color: black; border: none; cursor: pointer;">
                            –°–∫–∞—á–∞—Ç—å PDF
                        </button>
                        <button onclick="window.location.href='../auth/register.html'" class="btn-secondary" style="background: transparent; color: white; border-color: rgba(255,255,255,0.2); cursor: pointer;">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç
                        </button>
                    </div>
                    <div style="margin-top: 16px; font-size: 12px; opacity: 0.6;">
                        –Ω–∞–≤—ã—Ä–æ—Å—Ç.—Ä—Ñ
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/data-manager.js"></script>
    <script src="../assets/js/app-config.js"></script>
    <script src="../assets/js/sidebar-logic.js"></script>
    <script src="../assets/js/modal.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = DataManager.getUser();
            if (user) {
                document.getElementById('auth-cta').style.display = 'block';
            } else {
                document.getElementById('guest-cta').style.display = 'block';
            }
        });

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        function formatMoney(num) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(num || 0));
        }

        function updateRowSums() {
            const inputRows = document.querySelectorAll('tr:has(.input-cell)');
            inputRows.forEach(row => {
                const inputs = row.querySelectorAll('.input-cell');
                const sumCell = row.querySelector('.row-sum');
                if (inputs.length > 0 && sumCell) {
                    const sum = Array.from(inputs).reduce((s, input) => s + (parseFloat(input.value) || 0), 0);
                    sumCell.textContent = formatMoney(sum);
                }
            });
        }

        function calculatePnL() {
            const taxRegime = document.getElementById('tax-regime').value;
            const months = 6;
            const revenue = [];
            const cogs = [];
            const opex = [];
            
            // Collect inputs
            for (let i = 0; i < months; i++) {
                revenue[i] = parseFloat(document.querySelectorAll('.revenue')[i]?.value || 0);
                cogs[i] = parseFloat(document.querySelectorAll('.cogs')[i]?.value || 0);
                
                // Opex Sum
                let monthOpex = 0;
                const opexRows = [
                    document.querySelectorAll('.opex')[i], // Marketing
                    document.querySelectorAll('.opex')[i + 6], // Salaries
                    document.querySelectorAll('.opex')[i + 12] // Rent
                ];
                
                opexRows.forEach(input => {
                    monthOpex += parseFloat(input?.value || 0);
                });
                opex[i] = monthOpex;
            }
            
            let totalRevenue = 0;
            let totalGrossProfit = 0;
            let totalOpex = 0;
            let totalTaxes = 0;
            let totalNetProfit = 0;
            
            for (let i = 0; i < months; i++) {
                const grossProfit = revenue[i] - cogs[i];
                
                let tax = 0;
                if (taxRegime === 'usn-6') {
                    tax = revenue[i] * 0.06;
                } else if (taxRegime === 'usn-15') {
                    const taxableIncome = revenue[i] - cogs[i] - opex[i];
                    tax = taxableIncome > 0 ? taxableIncome * 0.15 : 0;
                }
                
                const netProfit = grossProfit - opex[i] - tax;
                
                document.querySelectorAll('.gp')[i].textContent = formatMoney(grossProfit);
                document.querySelectorAll('.tax')[i].textContent = formatMoney(tax);
                document.querySelectorAll('.net')[i].textContent = formatMoney(netProfit);
                
                totalRevenue += revenue[i];
                totalGrossProfit += grossProfit;
                totalOpex += opex[i];
                totalTaxes += tax;
                totalNetProfit += netProfit;
            }
            
            document.querySelector('.gp-total').textContent = formatMoney(totalGrossProfit);
            document.querySelectorAll('.tax')[6].textContent = formatMoney(totalTaxes);
            document.querySelector('.net-total').textContent = formatMoney(totalNetProfit);
            
            updateRowSums();
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', calculatePnL);
            });
            document.getElementById('tax-regime').addEventListener('change', calculatePnL);
            
            // Load Data
            const currentProjectId = DataManager.getCurrentProjectId();
            if (currentProjectId) {
                const project = DataManager.getProject(currentProjectId);
                if (project && project.pnlData && project.pnlData.details) {
                    const d = project.pnlData.details;
                    if (d.revenue) {
                        d.revenue.forEach((val, i) => {
                            const el = document.querySelectorAll('.revenue')[i];
                            if(el) el.value = val;
                        });
                    }
                    if (d.cogs) {
                        d.cogs.forEach((val, i) => {
                            const el = document.querySelectorAll('.cogs')[i];
                            if(el) el.value = val;
                        });
                    }
                }
            }
            
            calculatePnL();
        });

        function saveToProject() {
            const currentProjectId = DataManager.getCurrentProjectId();
            if (!currentProjectId) {
                Modal.showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }

            // ... (rest of logic)
            // Capture arrays
            const months = 6;
            const revenueArr = [];
            const cogsArr = [];
            
            for(let i=0; i<months; i++) {
                revenueArr.push(parseFloat(document.querySelectorAll('.revenue')[i]?.value || 0));
                cogsArr.push(parseFloat(document.querySelectorAll('.cogs')[i]?.value || 0));
            }

            const totalRevenue = revenueArr.reduce((a,b) => a+b, 0);
            const totalNetProfit = parseFloat(document.querySelector('.net-total').textContent.replace(/[^\d.-]/g, '')) || 0;

            const data = {
                revenue: revenueArr,
                cogs: cogsArr,
                totalRevenue: totalRevenue,
                profit: totalNetProfit
            };
            
            DataManager.updateProject(currentProjectId, 'pnl', {
                revenue: totalRevenue, 
                profit: totalNetProfit, 
                details: data
            });
            
            Modal.showToast('P&L –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        }

        function exportPDF() {
            const element = document.querySelector('.pnl-container');
            const btn = document.getElementById('pdfBtn');
            const originalOverflow = element.style.overflowX;
            
            // Temporary fix for PDF scroll
            element.style.overflowX = 'visible';
            
            const opt = {
                margin: 10,
                filename: 'PnL_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };

            if (window.html2pdf) {
                Modal.setLoading(btn, true);
                html2pdf().set(opt).from(element).save().then(() => {
                    Modal.setLoading(btn, false, '–°–∫–∞—á–∞—Ç—å PDF');
                    Modal.showToast('PDF —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω');
                    element.style.overflowX = originalOverflow;
                });
            } else {
                Modal.showToast('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ PDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'error');
                element.style.overflowX = originalOverflow;
            }
        }
    </script>
</body>
</html>
