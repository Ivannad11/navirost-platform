<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&L –û—Ç—á–µ—Ç ‚Äî –ü—Ä–∏–±—ã–ª–∏ –∏ —É–±—ã—Ç–∫–∏ | –ù–∞–≤—ã—Ä–æ—Å—Ç</title>
    <link rel="stylesheet" href="../../assets/css/dashboard.css">
    <link rel="stylesheet" href="../../platform/css/calculators.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìâ</text></svg>">
    
    <style>
        /* P&L Specific Styles */
        .pnl-container {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 14px;
            color: var(--text-primary);
        }

        th:first-child, td:first-child {
            text-align: left;
            width: 200px;
            position: sticky;
            left: 0;
            background: var(--bg-surface);
            z-index: 10;
            border-right: 1px solid var(--border-subtle);
        }

        th {
            font-weight: 600;
            color: var(--text-tertiary);
            font-size: 12px;
            text-transform: uppercase;
            background: var(--bg-subtle);
        }

        .row-header {
            font-weight: 500;
            color: var(--text-primary);
        }

        .row-total {
            font-weight: 700;
            background: var(--bg-tertiary);
        }
        .row-total td:first-child { background: var(--bg-tertiary); }

        .input-cell {
            width: 100%;
            min-width: 80px;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 6px;
            text-align: right;
            font-family: inherit;
            font-size: 14px;
            background: transparent;
            transition: all 0.2s;
        }
        .input-cell:hover, .input-cell:focus {
            background: var(--bg-subtle);
            border-color: var(--border-subtle);
            outline: none;
        }

        .val-positive { color: #166534; }
        .val-negative { color: #DC2626; }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
    </style>
</head>
<body>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <a href="#" class="sidebar-logo">–Ω–∞–≤—ã—Ä–æ—Å—Ç.</a>
        <button class="burger-btn" onclick="toggleSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="dashboard-container no-sidebar-right">
        
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="../../index.html" class="sidebar-logo">–Ω–∞–≤—ã—Ä–æ—Å—Ç.</a>
            <ul class="nav-menu">
                <!-- Populated by sidebar-logic.js -->
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1 style="font-size: 24px; font-weight: 600; margin-bottom: 4px;">P&L –û—Ç—á–µ—Ç</h1>
                    <div style="font-size: 14px; color: var(--text-secondary);">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–±—ã–ª–µ–π –∏ —É–±—ã—Ç–∫–æ–≤ –Ω–∞ 6 –º–µ—Å—è—Ü–µ–≤</div>
                </div>
                <button class="btn-primary" onclick="savePnl()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
            
            <div class="pnl-container">
                <div class="form-group" style="margin-bottom: 24px; max-width: 300px;">
                    <label style="font-size: 13px; font-weight: 500; margin-bottom: 8px; display: block;">–ù–∞–ª–æ–≥–æ–≤—ã–π —Ä–µ–∂–∏–º</label>
                    <select id="tax-regime" class="form-input">
                        <option value="usn-6">–£–°–ù 6% (–î–æ—Ö–æ–¥—ã)</option>
                        <option value="usn-15">–£–°–ù 15% (–î–æ—Ö–æ–¥—ã –º–∏–Ω—É—Å —Ä–∞—Å—Ö–æ–¥—ã)</option>
                    </select>
                </div>

                <table id="pnlTable">
                    <thead>
                        <tr>
                            <th>–°—Ç–∞—Ç—å—è</th>
                            <th>–ú–µ—Å—è—Ü 1</th>
                            <th>–ú–µ—Å—è—Ü 2</th>
                            <th>–ú–µ—Å—è—Ü 3</th>
                            <th>–ú–µ—Å—è—Ü 4</th>
                            <th>–ú–µ—Å—è—Ü 5</th>
                            <th>–ú–µ—Å—è—Ü 6</th>
                            <th>–ò—Ç–æ–≥–æ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Revenue -->
                        <tr>
                            <td class="row-header">–í—ã—Ä—É—á–∫–∞ (Revenue)</td>
                            <td><input type="number" class="input-cell revenue" value="0"></td>
                            <td><input type="number" class="input-cell revenue" value="0"></td>
                            <td><input type="number" class="input-cell revenue" value="0"></td>
                            <td><input type="number" class="input-cell revenue" value="0"></td>
                            <td><input type="number" class="input-cell revenue" value="0"></td>
                            <td><input type="number" class="input-cell revenue" value="0"></td>
                            <td class="row-sum">0</td>
                        </tr>
                        
                        <!-- COGS -->
                        <tr>
                            <td class="row-header">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (COGS)</td>
                            <td><input type="number" class="input-cell cogs" value="0"></td>
                            <td><input type="number" class="input-cell cogs" value="0"></td>
                            <td><input type="number" class="input-cell cogs" value="0"></td>
                            <td><input type="number" class="input-cell cogs" value="0"></td>
                            <td><input type="number" class="input-cell cogs" value="0"></td>
                            <td><input type="number" class="input-cell cogs" value="0"></td>
                            <td class="row-sum">0</td>
                        </tr>

                        <!-- Gross Profit -->
                        <tr class="row-total">
                            <td>–í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å</td>
                            <td class="gp">0</td>
                            <td class="gp">0</td>
                            <td class="gp">0</td>
                            <td class="gp">0</td>
                            <td class="gp">0</td>
                            <td class="gp">0</td>
                            <td class="gp-total">0</td>
                        </tr>

                        <!-- OPEX Header -->
                        <tr>
                            <td colspan="8" style="text-align: left; font-size: 11px; font-weight: 600; color: var(--text-tertiary); padding-top: 24px; text-transform: uppercase;">–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (OPEX)</td>
                        </tr>

                        <!-- Marketing -->
                        <tr>
                            <td class="row-header">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td class="row-sum">0</td>
                        </tr>

                        <!-- Salaries -->
                        <tr>
                            <td class="row-header">–ó–∞—Ä–ø–ª–∞—Ç—ã (–§–û–¢)</td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td class="row-sum">0</td>
                        </tr>

                        <!-- Rent/Other -->
                        <tr>
                            <td class="row-header">–ê—Ä–µ–Ω–¥–∞ –∏ –ø—Ä–æ—á–µ–µ</td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td><input type="number" class="input-cell opex" value="0"></td>
                            <td class="row-sum">0</td>
                        </tr>

                        <!-- Taxes -->
                        <tr class="row-subtotal">
                            <td>–ù–∞–ª–æ–≥–∏</td>
                            <td class="tax">0</td>
                            <td class="tax">0</td>
                            <td class="tax">0</td>
                            <td class="tax">0</td>
                            <td class="tax">0</td>
                            <td class="tax">0</td>
                            <td class="row-sum">0</td>
                        </tr>

                        <!-- Net Profit -->
                        <tr class="row-total" style="border-top: 2px solid var(--border-subtle);">
                            <td>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</td>
                            <td class="net">0</td>
                            <td class="net">0</td>
                            <td class="net">0</td>
                            <td class="net">0</td>
                            <td class="net">0</td>
                            <td class="net">0</td>
                            <td class="net-total">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/data-manager.js"></script>
    <script src="../../assets/js/app-config.js"></script>
    <script src="../../assets/js/sidebar-logic.js"></script>
    <script src="../../assets/js/modal.js"></script>
    
    <script>
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        // Auth Check
        if (!DataManager.getUser()) {
            window.location.href = '../../auth/login.html';
        }

        function formatMoney(num) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(num || 0));
        }

        function updateRowSums() {
            // Update sums for each input row
            const inputRows = document.querySelectorAll('tr:has(.input-cell)');
            inputRows.forEach(row => {
                const inputs = row.querySelectorAll('.input-cell');
                const sumCell = row.querySelector('.row-sum');
                if (inputs.length > 0 && sumCell) {
                    const sum = Array.from(inputs).reduce((s, input) => s + (parseFloat(input.value) || 0), 0);
                    sumCell.textContent = formatMoney(sum);
                }
            });
        }

        function calculatePnL() {
            const taxRegime = document.getElementById('tax-regime').value;
            const months = 6;
            const revenue = [];
            const cogs = [];
            const opex = [];
            
            // Collect inputs per column
            for (let i = 0; i < months; i++) {
                revenue[i] = parseFloat(document.querySelectorAll('.revenue')[i]?.value || 0);
                cogs[i] = parseFloat(document.querySelectorAll('.cogs')[i]?.value || 0);
                
                // Sum all opex rows for this column
                let monthOpex = 0;
                const opexInputs = document.querySelectorAll('.opex');
                // opexInputs is a flat list. We need to grab every i-th element from groups of 6?
                // No, structure is rows.
                // Row 1: 0..5
                // Row 2: 6..11
                // Row 3: 12..17
                // Total opex rows = 3. Total inputs = 18.
                // Column i corresponds to indices: i, i+6, i+12
                
                const rowsCount = 3; // Marketing, Salaries, Rent
                for(let r=0; r<rowsCount; r++) {
                    const val = opexInputs[r * months + i]?.value || 0;
                    monthOpex += parseFloat(val);
                }
                opex[i] = monthOpex;
            }
            
            let totalRevenue = 0;
            let totalGrossProfit = 0;
            let totalOpex = 0;
            let totalTaxes = 0;
            let totalNetProfit = 0;
            
            for (let i = 0; i < months; i++) {
                const grossProfit = revenue[i] - cogs[i];
                
                let tax = 0;
                if (taxRegime === 'usn-6') {
                    tax = revenue[i] * 0.06;
                } else if (taxRegime === 'usn-15') {
                    const taxableIncome = revenue[i] - cogs[i] - opex[i];
                    tax = taxableIncome > 0 ? taxableIncome * 0.15 : 0;
                }
                
                const netProfit = grossProfit - opex[i] - tax;
                
                document.querySelectorAll('.gp')[i].textContent = formatMoney(grossProfit);
                document.querySelectorAll('.tax')[i].textContent = formatMoney(tax);
                document.querySelectorAll('.net')[i].textContent = formatMoney(netProfit);
                
                // Colorize Net Profit
                const netCell = document.querySelectorAll('.net')[i];
                netCell.className = 'net ' + (netProfit >= 0 ? 'val-positive' : 'val-negative');
                
                totalRevenue += revenue[i];
                totalGrossProfit += grossProfit;
                totalOpex += opex[i];
                totalTaxes += tax;
                totalNetProfit += netProfit;
            }
            
            document.querySelector('.gp-total').textContent = formatMoney(totalGrossProfit);
            
            // Taxes Total (find the last tax cell or by class)
            // The row-sum for taxes is the 7th element with class 'tax' if we queryAll('.tax')? No.
            // Query selector logic in updateRowSums handles inputs.
            // For calculated rows, we need manual update.
            const taxCells = document.querySelectorAll('.tax');
            // Last cell in tax row is the sum
            // Structure: 6 cells + 1 sum cell? No, table has 8 cols.
            // <td>Label</td>, 6x <td>Data</td>, <td>Total</td>
            // In calculate loop I updated 0..5.
            // The 6th index (7th cell) is total. But my loop only goes to 5.
            // Wait, HTML structure:
            /*
            <tr class="row-subtotal">
                <td>–ù–∞–ª–æ–≥–∏</td>
                <td class="tax">0</td> ... (6 times)
                <td class="row-sum">0</td>
            </tr>
            */
            // So .tax has 6 elements. .row-sum is separate.
            // I need to update that specific row-sum.
            // Let's use specific IDs or relative navigation, but simplified:
            // Just find the tax row and its last cell.
            const taxRow = document.querySelector('.row-subtotal');
            if(taxRow) taxRow.querySelector('.row-sum').textContent = formatMoney(totalTaxes);
            
            const netRow = document.querySelector('tr[style*="border-top"]'); // Hacky but works for now
            if(netRow) {
                const totalCell = netRow.querySelector('.net-total');
                if(totalCell) {
                    totalCell.textContent = formatMoney(totalNetProfit);
                    totalCell.className = 'net-total ' + (totalNetProfit >= 0 ? 'val-positive' : 'val-negative');
                }
            }
            
            updateRowSums();
            
            return { revenue: totalRevenue, profit: totalNetProfit };
        }

        function savePnl() {
            const stats = calculatePnL();
            const currentProjectId = DataManager.getCurrentProjectId();
            
            if (currentProjectId) {
                const allInputs = Array.from(document.querySelectorAll('.input-cell')).map(i => i.value);
                const data = {
                    inputs: allInputs,
                    revenue: stats.revenue,
                    profit: stats.profit
                };
                
                DataManager.updateProject(currentProjectId, 'pnl', data);
                Modal.showToast('P&L —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç!');
            } else {
                Modal.showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            const currentProjectId = DataManager.getCurrentProjectId();
            if (currentProjectId) {
                const project = DataManager.getProject(currentProjectId);
                if (project && project.pnlData && project.pnlData.inputs) {
                    const inputs = document.querySelectorAll('.input-cell');
                    project.pnlData.inputs.forEach((val, i) => {
                        if (inputs[i]) inputs[i].value = val;
                    });
                }
            }
            
            calculatePnL();
            
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', calculatePnL);
            });
            document.getElementById('tax-regime').addEventListener('change', calculatePnL);
        });
    </script>
</body>
</html>