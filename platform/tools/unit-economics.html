<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Æ–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏ ‚Äî –Ω–∞–≤—ã—Ä–æ—Å—Ç.</title>
    <link rel="stylesheet" href="../../assets/css/dashboard.css">
    <link rel="stylesheet" href="../../platform/css/calculators.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üî¢</text></svg>">
    
    <style>
        .calculator-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0; 
        }
        
        .calc-header {
            text-align: left;
            margin-bottom: 32px;
        }
        
        .calc-header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .calc-header p {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 100%;
            margin: 0;
            text-align: left;
        }
        
        .calc-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 24px;
        }
        
        .calc-inputs,
        .calc-results {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }
        
        .calc-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .form-input {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-subtle);
            border: 1px solid var(--border-subtle);
        }
        
        .result-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border-subtle);
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .result-value {
            font-size: 24px;
        }
        
        .cta-block {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-top: 32px;
            color: var(--text-primary);
            background: linear-gradient(135deg, #F4F4F5 0%, #FFFFFF 100%);
        }
        
        .cta-block h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .cta-block p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            opacity: 1;
        }

        @media (max-width: 1024px) {
            .calc-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <a href="#" class="sidebar-logo">–Ω–∞–≤—ã—Ä–æ—Å—Ç.</a>
        <button class="burger-btn" onclick="toggleSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="dashboard-container no-sidebar-right">
        
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="../../index.html" class="sidebar-logo">–Ω–∞–≤—ã—Ä–æ—Å—Ç.</a>
            <ul class="nav-menu">
                <!-- Populated by sidebar-logic.js -->
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            
            <div class="calculator-container">
                <div class="calc-header">
                    <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏</h1>
                    <p>–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ LTV, CAC, –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ —Å—Ä–æ–∫ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏.</p>
                </div>

                <div class="calc-layout">
                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
                    <div class="calc-inputs">
                        <h3 class="calc-section-title">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</h3>
                        
                        <div class="form-group">
                            <label>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (—Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏), ‚ÇΩ</label>
                            <input type="number" id="average-check" class="form-input" placeholder="1000" value="1000">
                            <div class="helper-text">–°–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç –ø–ª–∞—Ç–∏—Ç –∑–∞ –æ–¥–Ω—É –ø–æ–∫—É–ø–∫—É</div>
                        </div>
                        
                        <div class="form-group">
                            <label>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (COGS), ‚ÇΩ</label>
                            <input type="number" id="cogs" class="form-input" placeholder="400" value="400">
                            <div class="helper-text">–ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ/–∑–∞–∫—É–ø–∫—É —Ç–æ–≤–∞—Ä–∞</div>
                        </div>
                        
                        <div class="form-group">
                            <label>–≠–∫–≤–∞–π—Ä–∏–Ω–≥ (%)</label>
                            <input type="number" id="acquiring" class="form-input" placeholder="2" value="2" step="0.1">
                            <div class="helper-text">–ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–æ–±—ã—á–Ω–æ 1.5-3%)</div>
                        </div>
                        
                        <div class="form-group">
                            <label>–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∫—É–ø–æ–∫ (APC)</label>
                            <input type="number" id="apc" class="form-input" placeholder="5" value="5">
                            <div class="helper-text">–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∫–ª–∏–µ–Ω—Ç –ø–æ–∫—É–ø–∞–µ—Ç –∑–∞ –≤—Å—é –∂–∏–∑–Ω—å</div>
                        </div>
                        
                        <div class="form-group">
                            <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ (CAC), ‚ÇΩ</label>
                            <input type="number" id="cac" class="form-input" placeholder="800" value="800">
                            <div class="helper-text">–°–∫–æ–ª—å–∫–æ —Ç—Ä–∞—Ç–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ —á—Ç–æ–±—ã –ø—Ä–∏–≤–ª–µ—á—å 1 –∫–ª–∏–µ–Ω—Ç–∞</div>
                        </div>
                    </div>

                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                    <div class="calc-results">
                        <h3 class="calc-section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                        
                        <div class="result-card">
                            <div class="result-label">–ú–∞—Ä–∂–∞ —Å 1 –ø—Ä–æ–¥–∞–∂–∏</div>
                            <div class="result-value" id="result-cm">0 ‚ÇΩ</div>
                            <div id="tip-margin" style="font-size: 11px; margin-top: 4px; display: none;"></div>
                        </div>

                        <!-- Chart -->
                        <div style="height: 180px; margin-bottom: 24px;">
                            <canvas id="unitChart"></canvas>
                        </div>
                        
                        <div class="result-card">
                            <div class="result-label">LTV (–ø—Ä–∏–±—ã–ª—å –∑–∞ –≤—Å–µ –ø–æ–∫—É–ø–∫–∏)</div>
                            <div class="result-value" id="result-ltv">0 ‚ÇΩ</div>
                        </div>
                        
                        <div class="result-card">
                            <div class="result-label">–ü—Ä–∏–±—ã–ª—å —Å –∫–ª–∏–µ–Ω—Ç–∞</div>
                            <div class="result-value" id="result-lifetime-profit">0 ‚ÇΩ</div>
                        </div>
                        
                        <div class="result-card">
                            <div class="result-label">ROMI (–≤–æ–∑–≤—Ä–∞—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π)</div>
                            <div class="result-value" id="result-romi">0%</div>
                        </div>
                        
                        <div class="result-card">
                            <div class="result-label">–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Å</div>
                            <div class="result-value" id="result-payback">-</div>
                        </div>
                    </div>
                </div>

                <div class="cta-block" id="save-cta">
                    <h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç?</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç—ã –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏–∫—É.</p>
                    <button class="btn-primary" onclick="saveToProject()">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/data-manager.js"></script>
    <script src="../../assets/js/app-config.js"></script>
    <script src="../../assets/js/sidebar-logic.js"></script>
    <script src="../../assets/js/modal.js"></script>
    
    <script>
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        // Auth Check
        if (!DataManager.getUser()) {
            window.location.href = '../../auth/login.html';
        }

        function calculateUnitEconomics() {
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const averageCheck = parseFloat(document.getElementById('average-check').value) || 0;
            const cogs = parseFloat(document.getElementById('cogs').value) || 0;
            const acquiring = parseFloat(document.getElementById('acquiring').value) || 0;
            const apc = parseFloat(document.getElementById('apc').value) || 1;
            const cac = parseFloat(document.getElementById('cac').value) || 0;

            // –†–∞—Å—á–µ—Ç—ã –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º—É–ª–∞–º
            const cm = averageCheck - cogs - (averageCheck * acquiring / 100);
            const ltv = cm * apc;
            const lifetimeProfit = ltv - cac;
            const romi = cac > 0 ? ((lifetimeProfit / cac) * 100).toFixed(1) : '‚Äî';
            const payback = cm > 0 ? Math.ceil(cac / cm) : '‚Äî';

            // –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            document.getElementById('result-cm').innerText = Math.round(cm) + ' ‚ÇΩ';
            document.getElementById('result-ltv').innerText = Math.round(ltv) + ' ‚ÇΩ';
            document.getElementById('result-lifetime-profit').innerText = Math.round(lifetimeProfit) + ' ‚ÇΩ';
            document.getElementById('result-romi').innerText = romi === '‚Äî' ? '‚Äî' : romi + '%';
            document.getElementById('result-payback').innerText = payback === '‚Äî' ? '‚Äî' : payback + ' –ø–æ–∫—É–ø–æ–∫';
            
            updateChart(averageCheck, cogs, (averageCheck * acquiring / 100), cm);
            
            // AI Contextual Tip
            if (window.AIAdvisor) {
                const marginPercent = averageCheck > 0 ? (cm / averageCheck) * 100 : 0;
                const tipEl = document.getElementById('tip-margin');
                
                if (marginPercent < 20) {
                    tipEl.style.display = 'block';
                    tipEl.style.color = '#DC2626';
                    tipEl.innerText = '‚ö†Ô∏è –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞ (<20%). –†–∏—Å–∫ –∫–∞—Å—Å–æ–≤–æ–≥–æ —Ä–∞–∑—Ä—ã–≤–∞.';
                } else if (marginPercent > 50) {
                    tipEl.style.display = 'block';
                    tipEl.style.color = '#16A34A';
                    tipEl.innerText = '‚úÖ –û—Ç–ª–∏—á–Ω–∞—è –º–∞—Ä–∂–∞ (>50%). –ú–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å.';
                } else {
                    tipEl.style.display = 'none';
                }
            }
        }

        // --- Chart Logic ---
        let unitChartInstance = null;

        function updateChart(revenue, cogs, tax, margin) {
            const ctx = document.getElementById('unitChart');
            if (!ctx) return;
            
            if (unitChartInstance) unitChartInstance.destroy();
            
            unitChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–ù–∞–ª–æ–≥–∏/–ö–æ–º–∏—Å—Å–∏–∏', '–ú–∞—Ä–∂–∞'],
                    datasets: [{
                        data: [cogs, tax, margin],
                        backgroundColor: [
                            '#EF4444', // Red
                            '#F59E0B', // Orange
                            '#10B981'  // Green
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } }
                    },
                    cutout: '70%'
                }
            });
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–æ–±—ã—Ç–∏—è–º
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', calculateUnitEconomics);
        });

        // Save functionality
        function saveToProject() {
            const currentProjectId = DataManager.getCurrentProjectId();
            if (!currentProjectId) {
                Modal.showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            // Get values
            const data = {
                averageCheck: parseFloat(document.getElementById('average-check').value) || 0,
                cogs: parseFloat(document.getElementById('cogs').value) || 0,
                acquiring: parseFloat(document.getElementById('acquiring').value) || 0,
                apc: parseFloat(document.getElementById('apc').value) || 0,
                cac: parseFloat(document.getElementById('cac').value) || 0,
                margin: parseFloat(document.getElementById('result-cm').innerText.replace(/[^\d.-]/g, '')) || 0
            };

            DataManager.updateProject(currentProjectId, 'unit', data);
            Modal.showToast('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç!');
        }

        // Load data if project selected
        document.addEventListener('DOMContentLoaded', () => {
            const currentProjectId = DataManager.getCurrentProjectId();
            if (currentProjectId) {
                const project = DataManager.getProject(currentProjectId);
                if (project && project.unitData) {
                    const d = project.unitData;
                    if(d.averageCheck) document.getElementById('average-check').value = d.averageCheck;
                    if(d.cogs) document.getElementById('cogs').value = d.cogs;
                    if(d.acquiring) document.getElementById('acquiring').value = d.acquiring;
                    if(d.apc) document.getElementById('apc').value = d.apc;
                    if(d.cac) document.getElementById('cac').value = d.cac;
                }
            }
            // Always calc at end
            calculateUnitEconomics();
        });
    </script>
</body>
</html>