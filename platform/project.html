<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–µ–∫—Ç ‚Äî –Ω–∞–≤—ã—Ä–æ—Å—Ç.</title>
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/modal.css">
</head>
<body>

    <div class="dashboard-container">
        
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="../index.html" class="sidebar-logo">–Ω–∞–≤—ã—Ä–æ—Å—Ç.</a>
            <ul class="nav-menu">
                <!-- Populated by sidebar-logic.js -->
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <a href="./home.html" class="back-link" style="display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-tertiary); margin-bottom: 24px; text-decoration: none;">
                <span>‚Üê</span> –ù–∞ –≥–ª–∞–≤–Ω—É—é
            </a>

            <div class="dashboard-header">
                <div class="welcome-text">
                    <h1 id="projName" style="font-size: 24px; font-weight: 600; color: var(--text-primary);">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <div class="date-text">–û–±–∑–æ—Ä –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞</div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-secondary" onclick="editProject()" style="border: 1px solid var(--border-strong); background: white;">
                        ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                    </button>
                    <button class="btn-secondary" onclick="deleteProject()" style="color: #EF4444; border-color: var(--border-light);">
                        üóë –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
            
            <!-- Metrics Grid -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <span>–í—ã—Ä—É—á–∫–∞ (–ø–ª–∞–Ω)</span>
                        <span>üí∞</span>
                    </div>
                    <div class="metric-value" id="statRevenue">0 ‚ÇΩ</div>
                    <div class="metric-trend trend-neutral">
                        <span>‚Äî</span> –ò–∑ P&L –æ—Ç—á–µ—Ç–∞
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <span>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</span>
                        <span>üìà</span>
                    </div>
                    <div class="metric-value" id="statProfit">0 ‚ÇΩ</div>
                    <div class="metric-trend trend-neutral">
                        <span>‚Äî</span> –ò–∑ P&L –æ—Ç—á–µ—Ç–∞
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <span>–ú–∞—Ä–∂–∞ —Å –ø—Ä–æ–¥–∞–∂–∏</span>
                        <span>üéØ</span>
                    </div>
                    <div class="metric-value" id="statMargin">0 ‚ÇΩ</div>
                    <div class="metric-trend trend-neutral">
                        <span>‚Äî</span> –ò–∑ –Æ–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏
                    </div>
                </div>
            </div>
            
            <!-- Tools Grid -->
            <div class="section-header" style="margin-top: 40px;">
                <div class="section-title">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞</div>
            </div>

            <div class="projects-grid" id="projectToolsGrid" style="grid-template-columns: repeat(2, 1fr);">
                <!-- Populated by JS -->
            </div>
        </main>
        
        <!-- Right Panel (Optional, or removed for project view to give more space) -->
        <!-- Let's keep it clean for project view, so no right sidebar -->

    </div>

    <script src="../assets/js/data-manager.js"></script>
    <script src="../assets/js/app-config.js"></script>
    <script src="../assets/js/sidebar-logic.js"></script>
    <script src="../assets/js/modal.js"></script>
    <script>
        // Check auth
        const user = DataManager.getUser();
        if (!user) {
            window.location.href = '../auth/login.html';
        }

        const projectId = DataManager.getCurrentProjectId();
        const project = DataManager.getProject(projectId);

        if (!project) {
            window.location.href = './home.html';
        }

        // Render
        document.getElementById('projName').innerText = project.name;
        
        if (project.stats.revenue) document.getElementById('statRevenue').innerText = DataManager.formatMoney(project.stats.revenue);
        if (project.stats.profit) {
            const el = document.getElementById('statProfit');
            el.innerText = DataManager.formatMoney(project.stats.profit);
            el.style.color = project.stats.profit >= 0 ? '#166534' : '#DC2626';
        }
        if (project.stats.margin) document.getElementById('statMargin').innerText = DataManager.formatMoney(project.stats.margin);

        // Render Tools Dynamically
        const toolsGrid = document.getElementById('projectToolsGrid');
        toolsGrid.innerHTML = '';
        
        const projectTools = AppConfig.modules.filter(m => m.showInProject);
        
        projectTools.forEach(m => {
            // Determine status
            let status = '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ';
            let statusClass = '';
            let statusColor = 'var(--text-tertiary)';
            
            if (m.id === 'unit' && project.unitData) {
                status = '–ó–∞–ø–æ–ª–Ω–µ–Ω–æ';
                statusClass = 'done';
                statusColor = '#16A34A';
            }
            if (m.id === 'pnl' && project.pnlData) {
                status = '–ó–∞–ø–æ–ª–Ω–µ–Ω–æ';
                statusClass = 'done';
                statusColor = '#16A34A';
            }

            const el = document.createElement('div');
            el.className = 'project-card'; // Reuse project card style
            el.style.cursor = 'pointer';
            el.onclick = () => window.location.href = m.url;
            el.innerHTML = `
                <div class="project-top">
                    <div class="project-icon" style="background: var(--bg-secondary);">${m.icon}</div>
                    <div class="project-status" style="color: ${statusColor}; background: var(--bg-tertiary);">${status}</div>
                </div>
                <div class="project-name" style="margin-top: 12px;">${m.title}</div>
                <div class="project-meta">${m.desc || ''}</div>
            `;
            toolsGrid.appendChild(el);
        });

        function editProject() {
            Modal.prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç', '–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', (newName) => {
                if (newName) {
                    project.name = newName;
                    // Save
                    const allProjects = DataManager.getProjects();
                    const idx = allProjects.findIndex(p => p.id === projectId);
                    if (idx !== -1) {
                        allProjects[idx].name = newName;
                        // Manual save to trigger sync
                        localStorage.setItem(DataManager.PROJECTS_KEY, JSON.stringify(allProjects));
                        if (window.SupabaseService && window.SupabaseService.isConnected()) {
                            window.SupabaseService.syncProjects(allProjects);
                        }
                        
                        // Update UI
                        document.getElementById('projName').innerText = newName;
                        Modal.showToast('–ü—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω');
                    }
                }
            });
        }

        function deleteProject() {
            Modal.confirm(
                '–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?',
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.',
                () => {
                    DataManager.deleteProject(projectId);
                    window.location.href = './home.html';
                }
            );
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }
    </script>
</body>
</html>
