<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî –Ω–∞–≤—ã—Ä–æ—Å—Ç.</title>
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/modal.css">
    <!-- Removed legacy styles to prevent conflicts, dashboard.css is self-contained -->
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <a href="#" class="sidebar-logo">–Ω–∞–≤—ã—Ä–æ—Å—Ç.</a>
        <button class="burger-btn" onclick="toggleSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="dashboard-container">
        
        <!-- 1. Sidebar -->
        <aside class="sidebar">
            <a href="../index.html" class="sidebar-logo">–Ω–∞–≤—ã—Ä–æ—Å—Ç.</a>
            
            <ul class="nav-menu">
                <!-- Populated by sidebar-logic.js -->
            </ul>
        </aside>

        <!-- 2. Main Content -->
        <main class="main-content">
            <div class="dashboard-header">
                <div class="welcome-text">
                    <h1 id="greeting">–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!</h1>
                    <div class="date-text" id="current-date">–°–µ–≥–æ–¥–Ω—è 12 –æ–∫—Ç—è–±—Ä—è</div>
                </div>
                <button class="btn-primary" onclick="createNewProject()">
                    <span>+</span> –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                </button>
            </div>

            <!-- Onboarding Wizard (Visible if not completed) -->
            <div id="onboarding-wizard" style="display: none; background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 24px; margin-bottom: 32px; box-shadow: var(--shadow-md);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                    <div>
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ù–∞–≤—ã—Ä–æ—Å—Ç!</h2>
                        <p style="font-size: 14px; color: var(--text-secondary);">–î–∞–≤–∞–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏–º –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∑–∞ 3 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞.</p>
                    </div>
                    <div style="text-align: right;">
                        <span style="font-size: 13px; font-weight: 600; color: var(--primary);">–®–∞–≥ <span id="wizard-step-num">1</span> –∏–∑ 3</span>
                        <div style="width: 100px; height: 6px; background: var(--bg-subtle); border-radius: 3px; margin-top: 8px; overflow: hidden;">
                            <div id="wizard-progress" style="width: 33%; height: 100%; background: var(--primary); transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Profile -->
                <div id="wizard-step-1" class="wizard-step">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?</label>
                            <input type="text" class="form-input" id="wiz-name" placeholder="–ò–≤–∞–Ω">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ / –ø—Ä–æ–µ–∫—Ç–∞</label>
                            <input type="text" class="form-input" id="wiz-company" placeholder="–ú–æ–π –°—Ç–∞—Ä—Ç–∞–ø">
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn-primary" onclick="nextStep(2)">–î–∞–ª–µ–µ ‚Üí</button>
                    </div>
                </div>

                <!-- Step 2: First Project -->
                <div id="wizard-step-2" class="wizard-step" style="display: none;">
                    <p style="margin-bottom: 16px; font-size: 14px;">–°–æ–∑–¥–∞–π—Ç–µ –≤–∞—à –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤–µ—Å—Ç–∏ —É—á–µ—Ç.</p>
                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <input type="text" class="form-input" id="wiz-project" placeholder="–ó–∞–ø—É—Å–∫ –∫–æ—Ñ–µ–π–Ω–∏">
                    </div>
                    <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                         <button class="btn-secondary" onclick="prevStep(1)">‚Üê –ù–∞–∑–∞–¥</button>
                         <button class="btn-primary" onclick="nextStep(3)">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                    </div>
                </div>

                <!-- Step 3: Goal -->
                <div id="wizard-step-3" class="wizard-step" style="display: none;">
                     <p style="margin-bottom: 16px; font-size: 14px;">–ö–∞–∫–∞—è –≤–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å —Å–µ–π—á–∞—Å?</p>
                     <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;">
                         <div class="goal-card" onclick="selectGoal(this, 'start')" style="border: 1px solid var(--border-subtle); padding: 16px; border-radius: 8px; cursor: pointer; text-align: center;">
                             <div style="font-size: 24px; margin-bottom: 8px;">üöÄ</div>
                             <div style="font-size: 13px; font-weight: 500;">–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–∏–∑–Ω–µ—Å</div>
                         </div>
                         <div class="goal-card" onclick="selectGoal(this, 'grow')" style="border: 1px solid var(--border-subtle); padding: 16px; border-radius: 8px; cursor: pointer; text-align: center;">
                             <div style="font-size: 24px; margin-bottom: 8px;">üìà</div>
                             <div style="font-size: 13px; font-weight: 500;">–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å</div>
                         </div>
                         <div class="goal-card" onclick="selectGoal(this, 'fix')" style="border: 1px solid var(--border-subtle); padding: 16px; border-radius: 8px; cursor: pointer; text-align: center;">
                             <div style="font-size: 24px; margin-bottom: 8px;">üîß</div>
                             <div style="font-size: 13px; font-weight: 500;">–ù–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫</div>
                         </div>
                     </div>
                     <div style="display: flex; justify-content: space-between;">
                        <button class="btn-secondary" onclick="prevStep(2)">‚Üê –ù–∞–∑–∞–¥</button>
                        <button class="btn-primary" onclick="finishWizard()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É</button>
                   </div>
                </div>
            </div>

            <!-- Financial Metrics (Focus) -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <span>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ (–ü–ª–∞–Ω)</span>
                        <span>üí∞</span>
                    </div>
                    <div class="metric-value" id="total-revenue">0 ‚ÇΩ</div>
                    <div class="metric-trend trend-neutral">
                        <span>‚Äî</span> –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 6 –º–µ—Å.
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <span>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (–ü–ª–∞–Ω)</span>
                        <span>üìà</span>
                    </div>
                    <div class="metric-value" id="total-profit">0 ‚ÇΩ</div>
                    <div class="metric-trend trend-up">
                        <span>‚Äî</span> –°—É–º–º–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <span>–°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å</span>
                        <span>üéØ</span>
                    </div>
                    <div class="metric-value" id="avg-margin">0%</div>
                    <div class="metric-trend trend-neutral">
                        <span>‚Äî</span> –¶–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å
                    </div>
                </div>
            </div>

            <!-- Revenue Chart -->
            <div class="chart-container" style="background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 24px; margin-bottom: 32px; box-shadow: var(--shadow-sm);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="font-size: 16px; font-weight: 600;">–î–∏–Ω–∞–º–∏–∫–∞ –≤—ã—Ä—É—á–∫–∏ (6 –º–µ—Å—è—Ü–µ–≤)</h3>
                    <select id="chart-project-select" onchange="updateChart()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-subtle); font-size: 13px;">
                        <option value="all">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
                    </select>
                </div>
                <div style="height: 300px; width: 100%;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Projects Grid -->
            <div class="section-header">
                <div class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
            </div>
            
            <div class="projects-grid" id="projects-container">
                <!-- Populated by JS -->
            </div>
        </main>

        <!-- 3. Right Panel -->
        <aside class="right-sidebar">
            <!-- AI Advisor Widget -->
            <div id="ai-widget" style="background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); border-radius: 16px; padding: 20px; color: white; margin-bottom: 24px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: -10px; right: -10px; font-size: 60px; opacity: 0.1;">ü§ñ</div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span style="font-size: 18px;">‚ú®</span>
                    <span style="font-weight: 600; font-size: 14px;">AI –°–æ–≤–µ—Ç–Ω–∏–∫</span>
                </div>
                <div id="ai-content" style="font-size: 13px; line-height: 1.5; margin-bottom: 16px;">
                    –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ...
                </div>
                <button onclick="refreshAdvice()" style="background: rgba(255,255,255,0.2); border: none; padding: 6px 12px; border-radius: 6px; color: white; font-size: 11px; cursor: pointer; transition: background 0.2s;">
                    –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–≤–µ—Ç
                </button>
            </div>

            <!-- Onboarding Widget -->
            <div id="onboarding-widget">
                <div class="widget-title">–ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div class="progress-widget">
                    <div class="progress-header">
                        <span>–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</span>
                        <span id="onboarding-percent">0%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="onboarding-bar" style="width: 0%"></div>
                    </div>
                    <div class="checklist">
                        <div class="check-item" id="step-project">
                            <div class="check-circle"></div>
                            <span>–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç</span>
                        </div>
                        <div class="check-item" id="step-unit">
                            <div class="check-circle"></div>
                            <span>–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫—É</span>
                        </div>
                        <div class="check-item" id="step-profile">
                            <div class="check-circle"></div>
                            <span>–ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div>
                <div class="widget-title">–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø</div>
                <div class="quick-links">
                    <a href="tools/hourly-rate.html" class="quick-link-card">
                        <span>‚è±Ô∏è</span>
                        <div>
                            <div style="font-weight: 500; font-size: 13px;">–ü–æ—á–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞</div>
                            <div style="font-size: 11px; color: var(--text-tertiary);">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞</div>
                        </div>
                    </a>
                    <a href="tools/roi-calculator.html" class="quick-link-card">
                        <span>üìâ</span>
                        <div>
                            <div style="font-weight: 500; font-size: 13px;">ROI –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
                            <div style="font-size: 11px; color: var(--text-tertiary);">–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã</div>
                        </div>
                    </a>
                </div>
            </div>
        </aside>

    </div>

    <!-- Scripts -->
    <script src="../assets/js/data-manager.js"></script>
    <script src="../assets/js/app-config.js"></script>
    <script src="../assets/js/sidebar-logic.js"></script>
    <script src="../assets/js/modal.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
        });

        function initDashboard() {
            // 1. User & Header
            const user = DataManager.getUser();
            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }

            const hours = new Date().getHours();
            const greeting = hours < 12 ? '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ' : (hours < 18 ? '–î–æ–±—Ä—ã–π –¥–µ–Ω—å' : '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä');
            const name = user.name || '–ü—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å';
            document.getElementById('greeting').innerText = `${greeting}, ${name}!`;
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('ru-RU', options);

            // Note: Sidebar profile is handled by sidebar-logic.js now

            // 2. Load Projects & Metrics
            const projects = DataManager.getProjects();
            renderProjects(projects);
            calculateMetrics(projects);
            // renderSidebarProjects(projects); // Removed, handled by sidebar-logic.js
            
            // 3. Onboarding
            updateOnboarding(user);

            // 4. AI Advisor
            initAI();
        }

        function initAI() {
            if (window.AIAdvisor) {
                refreshAdvice();
            } else {
                // Wait for script load
                setTimeout(initAI, 500);
            }
        }

        function refreshAdvice() {
            const projects = DataManager.getProjects();
            const content = document.getElementById('ai-content');
            
            // Simple animation
            content.style.opacity = 0.5;
            
            setTimeout(() => {
                let advice = '';
                if (projects.length > 0) {
                    // Analyze first project for MVP
                    const insights = AIAdvisor.analyzeProject(projects[0]);
                    if (insights.length > 0) {
                        const i = insights[Math.floor(Math.random() * insights.length)];
                        advice = `<strong>${i.title}</strong><br>${i.text}`;
                    } else {
                         advice = AIAdvisor.getDailyTip();
                    }
                } else {
                    advice = AIAdvisor.getDailyTip();
                }
                
                content.innerHTML = advice;
                content.style.opacity = 1;
            }, 300);
        }

        function renderProjects(projects) {
            const container = document.getElementById('projects-container');
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1; text-align: center; padding: 48px 24px; background: var(--bg-surface); border: 1px dashed var(--border-strong); border-radius: 12px;">
                        <span class="empty-icon" style="font-size: 32px; display: block; margin-bottom: 16px;">üå±</span>
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</h3>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 24px;">–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤–µ—Å—Ç–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É—á–µ—Ç.</p>
                        <button class="btn-primary" onclick="createNewProject()">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                    </div>
                `;
                return;
            }

            let html = '';
            projects.forEach(p => {
                // Determine Status based on data presence
                const hasData = p.unitData || p.pnlData;
                const status = hasData ? '–í —Ä–∞–±–æ—Ç–µ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫';
                const statusClass = hasData ? 'status-active' : '';
                
                // Get Revenue/Profit for Preview
                const revenue = p.stats.revenue ? DataManager.formatMoney(p.stats.revenue) : '‚Äî';
                const profit = p.stats.profit ? DataManager.formatMoney(p.stats.profit) : '‚Äî';

                html += `
                    <div class="project-card" onclick="openProject('${p.id}')">
                        <div class="project-top">
                            <div class="project-icon">üöÄ</div>
                            <div class="project-status ${statusClass}">${status}</div>
                        </div>
                        <div class="project-name">${p.name}</div>
                        <div class="project-meta">–û–±–Ω–æ–≤–ª–µ–Ω: ${DataManager.formatDate(p.updated)}</div>
                        
                        <div class="project-stats">
                            <div class="stat-group">
                                <span class="stat-label">–í—ã—Ä—É—á–∫–∞ (–ü–ª–∞–Ω)</span>
                                <span class="stat-num">${revenue}</span>
                            </div>
                            <div class="stat-group" style="text-align: right;">
                                <span class="stat-label">–ü—Ä–∏–±—ã–ª—å</span>
                                <span class="stat-num">${profit}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderSidebarProjects(projects) {
            const container = document.getElementById('sidebar-projects');
            let html = '';
            projects.forEach(p => {
                html += `
                    <a href="#" onclick="openProject('${p.id}')" class="nav-link">
                        <span style="width: 6px; height: 6px; border-radius: 50%; background: var(--border-strong);"></span>
                        ${p.name}
                    </a>
                `;
            });
            container.innerHTML = html;
        }

        function calculateMetrics(projects) {
            let totalRev = 0;
            let totalProfit = 0;
            let totalMargin = 0;
            let count = 0;

            projects.forEach(p => {
                // Check stats object or root properties depending on structure consistency
                const rev = p.stats?.revenue || 0;
                const prof = p.stats?.profit || 0;
                const marg = p.stats?.margin || 0;

                totalRev += rev;
                totalProfit += prof;
                
                if (marg > 0) {
                    totalMargin += marg;
                    count++;
                }
            });

            const avgMargin = count > 0 ? Math.round(totalMargin / count) : 0;

            document.getElementById('total-revenue').innerText = DataManager.formatMoney(totalRev);
            document.getElementById('total-profit').innerText = DataManager.formatMoney(totalProfit);
            document.getElementById('avg-margin').innerText = avgMargin + '%';
        }

        function updateOnboarding(user) {
            const ob = user.onboarding || {};
            let completed = 0;
            const total = 3;

            if (ob.projectCreated) {
                completed++;
                document.getElementById('step-project').classList.add('done');
            }
            if (ob.unitCalc) {
                completed++;
                document.getElementById('step-unit').classList.add('done');
            }
            if (user.company) { // Assuming profile filled if company set
                completed++;
                document.getElementById('step-profile').classList.add('done');
            }

            const pct = Math.round((completed / total) * 100);
            document.getElementById('onboarding-percent').innerText = pct + '%';
            document.getElementById('onboarding-bar').style.width = pct + '%';
            
            if (pct === 100) {
                // Optional: Hide widget or show success message
                document.querySelector('.widget-title').innerText = 'üéâ –í—Å–µ –≥–æ—Ç–æ–≤–æ!';
            }
        }

        function createNewProject() {
            Modal.prompt(
                '–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç', 
                '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:', 
                (name) => {
                    const project = DataManager.createProject(name);
                    initDashboard(); // Reload data
                }
            );
        }

        function openProject(id) {
            DataManager.setCurrentProjectId(id);
            window.location.href = 'project.html';
        }

        let revenueChartInstance = null;

        function initChart(projects) {
            // Populate selector
            const selector = document.getElementById('chart-project-select');
            selector.innerHTML = '<option value="all">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>';
            projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.innerText = p.name;
                selector.appendChild(opt);
            });

            renderChartData(projects);
        }

        function updateChart() {
            const projects = DataManager.getProjects();
            const selectedId = document.getElementById('chart-project-select').value;
            
            let filtered = projects;
            if (selectedId !== 'all') {
                filtered = projects.filter(p => p.id === selectedId);
            }
            renderChartData(filtered);
        }

        function renderChartData(projects) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Aggregate Data (Month 1-6)
            const months = ['–ú–µ—Å—è—Ü 1', '–ú–µ—Å—è—Ü 2', '–ú–µ—Å—è—Ü 3', '–ú–µ—Å—è—Ü 4', '–ú–µ—Å—è—Ü 5', '–ú–µ—Å—è—Ü 6'];
            let datasets = [];

            // If "All", we sum up or show multiple lines?
            // Let's show Total Revenue and Total Net Profit bars
            
            let totalRevenue = [0,0,0,0,0,0];
            let totalProfit = [0,0,0,0,0,0];

            projects.forEach(p => {
                if (p.pnlData && p.pnlData.details && p.pnlData.details.revenue) {
                    p.pnlData.details.revenue.forEach((val, i) => {
                        if (i < 6) totalRevenue[i] += val;
                    });
                    // We don't have granular profit per month in simple storage yet, 
                    // only total profit. But if we had, we would sum it here.
                    // Let's just plot Revenue for now as we have the array.
                }
            });

            // Destroy previous
            if (revenueChartInstance) revenueChartInstance.destroy();

            revenueChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: '–í—ã—Ä—É—á–∫–∞ (Revenue)',
                        data: totalRevenue,
                        borderColor: '#18181B', // var(--text-primary)
                        backgroundColor: 'rgba(24, 24, 27, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        // --- Wizard Logic ---
        let selectedGoal = null;

        function checkWizardStatus(user) {
            // Force hide for now as requested
            document.getElementById('onboarding-wizard').style.display = 'none';
            return;

            /* 
            // Original Logic (Commented out)
            const projects = DataManager.getProjects();
            const wizard = document.getElementById('onboarding-wizard');
            
            if (localStorage.getItem('wizard_completed') === 'true') {
                wizard.style.display = 'none';
                return;
            }

            if (projects.length === 0 || !user.company) {
                wizard.style.display = 'block';
                if (user.name) document.getElementById('wiz-name').value = user.name;
                if (user.company) document.getElementById('wiz-company').value = user.company;
            }
            */
        }

        function nextStep(step) {
            const btn = event.target;
            
            // Validate Step 1
            if (step === 2) {
                const name = document.getElementById('wiz-name').value;
                const company = document.getElementById('wiz-company').value;
                if (!name) { Modal.showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è', 'error'); return; }
                
                // Save profile data
                const user = DataManager.getUser();
                user.name = name;
                user.company = company;
                DataManager.saveUser(user);
                Modal.showToast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            }

            // Validate Step 2
            if (step === 3) {
                const projName = document.getElementById('wiz-project').value;
                if (!projName) { Modal.showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞', 'error'); return; }
                
                Modal.setLoading(btn, true);
                
                // Create Project (simulate delay)
                setTimeout(() => {
                    DataManager.createProject(projName);
                    renderProjects(DataManager.getProjects()); 
                    Modal.setLoading(btn, false);
                    proceedToStep(step);
                    Modal.showToast('–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω');
                }, 600);
                return; // Stop here, proceed in callback
            }

            proceedToStep(step);
        }

        function proceedToStep(step) {
            // UI Transition
            document.querySelectorAll('.wizard-step').forEach(el => el.style.display = 'none');
            document.getElementById(`wizard-step-${step}`).style.display = 'block';
            
            // Progress
            document.getElementById('wizard-step-num').innerText = step;
            document.getElementById('wizard-progress').style.width = (step / 3 * 100) + '%';
        }


        function prevStep(step) {
            document.querySelectorAll('.wizard-step').forEach(el => el.style.display = 'none');
            document.getElementById(`wizard-step-${step}`).style.display = 'block';
            document.getElementById('wizard-step-num').innerText = step;
            document.getElementById('wizard-progress').style.width = (step / 3 * 100) + '%';
        }

        function selectGoal(el, goal) {
            document.querySelectorAll('.goal-card').forEach(c => c.style.borderColor = 'var(--border-subtle)');
            document.querySelectorAll('.goal-card').forEach(c => c.style.background = 'transparent');
            
            el.style.borderColor = 'var(--primary)';
            el.style.background = 'var(--bg-subtle)';
            selectedGoal = goal;
        }

        function finishWizard() {
            localStorage.setItem('wizard_completed', 'true');
            document.getElementById('onboarding-wizard').style.display = 'none';
            // Refresh dashboard
            initDashboard();
        }

        // Add check to init
        const originalInit = initDashboard;
        initDashboard = function() {
            originalInit(); // Call original logic
            const user = DataManager.getUser();
            if (user) checkWizardStatus(user);
        };
    </script>
</body>
</html>
